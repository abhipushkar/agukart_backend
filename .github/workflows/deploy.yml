name: Deploy Backend to AWS EC2

on:
  push:
    branches:
      - main   # deploy only on main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.AWS_SSH_KEY }}

      # OPTIONAL: GitHub host (safe to keep)
      - name: Add GitHub to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # ðŸ”¥ AWS EC2 (NO ssh-keyscan issues)
      - name: Add AWS EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 65.1.111.83 >> ~/.ssh/known_hosts || true

      - name: Set deploy variables
        run: |
          echo "BRANCH=main" >> $GITHUB_ENV
          echo "DEPLOY_PATH=/var/www/html/backend" >> $GITHUB_ENV

      - name: Deploy Backend on AWS
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@65.1.111.83 << 'EOF'
            set -e

            echo "ðŸš€ Deploying Backend on AWS..."

            node -v
            npm -v

            cd /var/www/html/backend

            git fetch origin
            git checkout main
            git reset --hard origin/main

            npm install
            npm run build || true

            pm2 describe agukart-backend > /dev/null \
              && pm2 restart agukart-backend --update-env \
              || pm2 start dist/app.js --name agukart-backend --update-env

            pm2 save

            echo "âœ… Backend deployed successfully on AWS"
          EOF
